# Каталог книг на Yii2

## Описание проекта

Разработан небольшой каталог книг с использованием фреймворка Yii2 и базы данных MySQL. Проект реализует все требования технического задания, включая возможность наличия нескольких авторов у одной книги, систему подписок на авторов и отчетность.

## Основные возможности

### Для неавторизованных пользователей:
- Просмотр каталога книг с фильтрацией
- Просмотр списка авторов
- Оформление подписки на появление новых книг конкретного автора
- Просмотр отчета "Топ-10 авторов" за указанный год
- Детальный просмотр информации о книгах и авторах

### Для авторизованных пользователей (дополнительно):
- Создание, редактирование и удаление книг
- Создание, редактирование и удаление авторов
- Загрузка изображений обложек книг
- Назначение нескольких авторов для одной книги

## Технологический стек

- **Фреймворк**: Yii2 (Advanced template)
- **PHP**: Версия 8.0+
- **База данных**: MySQL 5.7+/MariaDB 10.2+
- **Frontend**: Bootstrap 4
- **Дополнительные расширения**:
  - yiisoft/yii2-bootstrap4
  - kartik-v/yii2-krajee-base

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone [repository-url]
cd book-catalog
```

### 2. Установка зависимостей

```bash
composer install
```

### 3. Инициализация проекта

```bash
php init
```
Выберите конфигурацию **Development (0)** для разработки.

### 4. Настройка базы данных

Создайте базу данных MySQL:
```sql
CREATE DATABASE book_catalog CHARACTER SET utf8 COLLATE utf8_unicode_ci;
```

Настройте подключение к БД в файле `common/config/main-local.php`:
```php
return [
    'components' => [
        'db' => [
            'class' => 'yii\db\Connection',
            'dsn' => 'mysql:host=localhost;dbname=book_catalog',
            'username' => 'root',
            'password' => '',
            'charset' => 'utf8',
        ],
    ],
];
```

### 5. Применение миграций

```bash
php yii migrate
```

### 6. Заполнение тестовыми данными

```bash
php yii seed
```
Будет создан тестовый пользователь и данные:
- **Логин**: `admin`
- **Пароль**: `admin123`

### 7. Настройка веб-сервера

#### Вариант A: Встроенный PHP сервер
```bash
php -S localhost:8080 -t frontend/web
```
Сайт будет доступен по адресу: http://localhost:8080

#### Вариант B: Apache/Nginx
Настройте виртуальный хост с корневой директорией `frontend/web`

#### Вариант C: Через директорию frontend/web
Доступ по URL: http://book-catalog.local/frontend/web/

## Структура проекта

```
book-catalog/
├── common/              # Общий код
│   ├── models/         # Модели данных
│   └── config/         # Общие конфигурации
├── frontend/           # Пользовательская часть
│   ├── controllers/    # Контроллеры
│   ├── views/         # Представления
│   ├── web/           # Веб-доступные файлы
│   └── config/        # Конфигурации frontend
├── console/            # Консольные команды
│   ├── controllers/   # Контроллеры консоли
│   ├── migrations/    # Миграции БД
│   └── config/        # Конфигурации консоли
└── vendor/            # Зависимости Composer
```

## Основные сущности базы данных

### Таблицы:
1. **`book`** - Книги
   - `id` - первичный ключ
   - `title` - название книги
   - `year` - год издания
   - `description` - описание
   - `isbn` - ISBN
   - `cover_image` - файл обложки
   - `created_at`, `updated_at` - временные метки

2. **`author`** - Авторы
   - `id` - первичный ключ
   - `name` - ФИО автора
   - `created_at`, `updated_at` - временные метки

3. **`book_author`** - Связь книг и авторов (многие-ко-многим)

4. **`subscription`** - Подписки на авторов
   - `id` - первичный ключ
   - `email` - email подписчика
   - `author_id` - ID автора
   - `created_at` - дата подписки

5. **`user`** - Пользователи системы
   - `id` - первичный ключ
   - `username` - логин
   - `email` - email
   - `password_hash` - хеш пароля

## Основные страницы

### 📚 Книги
- **Главная**: http://book-catalog.local/
- **Список книг**: http://book-catalog.local/index.php?r=book/index
- **Создание книги**: http://book-catalog.local/index.php?r=book/create
- **Просмотр книги**: http://book-catalog.local/index.php?r=book/view&id=[ID]

### 👥 Авторы
- **Список авторов**: http://book-catalog.local/index.php?r=author/index
- **Создание автора**: http://book-catalog.local/index.php?r=author/create
- **Просмотр автора**: http://book-catalog.local/index.php?r=author/view&id=[ID]
- **Подписка на автора**: доступна на странице просмотра автора

### 📊 Отчеты
- **Отчет по авторам**: http://book-catalog.local/index.php?r=book/report
- **Фильтр по году**: доступен выбор года для генерации отчета

### 🔐 Авторизация
- **Вход**: http://book-catalog.local/index.php?r=site/login
- **Выход**: через меню пользователя

## Особенности реализации

### 1. Множественные авторы
- Одна книга может иметь несколько авторов
- В форме создания/редактирования книги реализован мультиселект для выбора авторов
- Связь "многие-ко-многим" через промежуточную таблицу `book_author`

### 2. Загрузка файлов
- Реализована загрузка изображений обложек книг
- Файлы сохраняются в `frontend/web/uploads/covers/`
- Автоматическое удаление старых изображений при обновлении
- Поддержка форматов: PNG, JPG, JPEG

### 3. Система подписок
- Неавторизованные пользователи могут подписаться на авторов по email
- Уникальная подписка на пару "email-автор"
- Валидация email адреса
- Простое добавление подписки на странице автора

### 4. Отчетность
- Отчет "Топ-10 авторов" за указанный год
- Динамический выбор года через форму
- SQL запрос с агрегацией и сортировкой
- Доступен всем пользователям

### 5. Контроль доступа (RBAC)
- Разделение прав для авторизованных и неавторизованных пользователей
- Гости могут только просматривать
- Авторизованные пользователи имеют полный CRUD доступ
- Реализовано через AccessControl поведение в контроллерах

## API контроллеров

### BookController
- `actionIndex()` - список книг с фильтрацией
- `actionView($id)` - просмотр книги
- `actionCreate()` - создание книги
- `actionUpdate($id)` - редактирование книги
- `actionDelete($id)` - удаление книги
- `actionReport()` - отчет по авторам

### AuthorController
- `actionIndex()` - список авторов
- `actionView($id)` - просмотр автора (с подпиской)
- `actionCreate()` - создание автора
- `actionUpdate($id)` - редактирование автора
- `actionDelete($id)` - удаление автора

## Тестовые данные

При запуске команды `php yii seed` создаются:

### Авторы (10 известных русских писателей):
1. Лев Толстой
2. Фёдор Достоевский
3. Антон Чехов
4. Иван Тургенев
5. Николай Гоголь
6. Александр Пушкин
7. Михаил Лермонтов
8. Иван Бунин
9. Александр Блок
10. Сергей Есенин

### Книги (10 классических произведений):
1. Война и мир
2. Анна Каренина
3. Преступление и наказание
4. Идиот
5. Вишнёвый сад
6. Дама с собачкой
7. Отцы и дети
8. Мёртвые души
9. Евгений Онегин
10. Герой нашего времени

### Тестовый пользователь:
- **Логин**: `admin`
- **Пароль**: `admin123`

## Миграции базы данных

В проекте реализованы две миграции:

### 1. Основные таблицы (`m240101_000001_create_tables`)
Создает все необходимые таблицы:
- `user` - пользователи
- `author` - авторы
- `book` - книги
- `book_author` - связь книг и авторов
- `subscription` - подписки

### 2. Тестовые данные (`m240101_000002_seed_data`)
Заполняет базу данных тестовыми данными

## Настройка окружения

### Разработка (Development)
- Включен YII_DEBUG
- Доступен Gii генератор кода
- Подробные ошибки
- Отключено кэширование

### Продакшн (Production)
- Отключен YII_DEBUG
- Общие сообщения об ошибках
- Включено кэширование
- Оптимизированная производительность

## Требования к системе

- PHP 8.0 или выше
- MySQL 5.7+ или MariaDB 10.2+
- Composer 2.0+
- Веб-сервер Apache/Nginx или встроенный PHP сервер
- Расширения PHP: pdo, pdo_mysql, gd (для работы с изображениями)

## Развертывание на продакшн

1. Изменить конфигурацию на Production:
```bash
php init
# Выбрать 1 (Production)
```

2. Настроить параметры БД в `common/config/main-local.php`

3. Установить зависимости:
```bash
composer install --no-dev --optimize-autoloader
```

4. Применить миграции:
```bash
php yii migrate
```

5. Настроить права на папки:
```bash
chmod 755 frontend/web/uploads
```

## Лицензия

Проект разработан для тестового задания. Используется лицензия MIT.

## Контакты

Разработчик: [Юрий Сергеев]
Telegram: @yms_sevastopol
email: ysergeev@yandex.ru

Дата разработки: Декабрь 2023